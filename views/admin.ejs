<%- include('./partials/header') %>
    <% if(error.length>0){ %>
        <div class="absolute top-10 left-1/2 -translate-x-1/2 -translate-y-1/2 p-3 rounded-md bg-red-500 z-[99]">
            <span class="inline-block mt-1 mb-1 text-white">
                <%= error %>
            </span>
        </div>
        <% } %>
            <div class="flex min-h-screen">

                <!-- Sidebar -->
                <aside class="w-64 bg-blue-900 text-white">
                    <h1 class="text-2xl font-bold p-5">Admin Panel</h1>
                    <ul>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('dashboard')">üìä Dashboard
                        </li>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('addProducts')">üì¶ Add
                            Products
                        </li>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('orders')">üßæ Orders</li>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('users')">üë§ Users</li>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('settings')">‚öôÔ∏è Settings
                        </li>
                        <li class="cursor-pointer p-2 hover:bg-gray-700" onclick="showSection('allProducts')">‚öôÔ∏è All
                            Products
                        </li>
                    </ul>
                </aside>

                <!-- Main Content -->
                <main class="min-h-screen flex-1 bg-gray-100 p-5">
                    <div id="dashboard" class="content">
                        <header class="bg-white shadow-md p-4 mb-6 flex justify-between items-center rounded-lg">
                            <h2 class="text-2xl font-semibold">Add New Product</h2>
                            <a href="/owners/logout"><button
                                    class="bg-gray-900 text-white px-4 py-2 rounded hover:bg-gray-700">Logout</button></a>
                        </header>
                        <section class="p-6 bg-gray-100">
                            <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Total Users Card -->
                                <div class="bg-white p-4 rounded-lg shadow-lg">
                                    <h3 class="text-lg font-semibold">Total Users</h3>
                                    <p class="text-2xl font-bold">
                                        <%=users%>
                                    </p>
                                </div>

                                <!-- Total Orders Card -->
                                <div class="bg-white p-4 rounded-lg shadow-lg">
                                    <h3 class="text-lg font-semibold">Total Orders</h3>
                                    <p class="text-2xl font-bold">
                                        <%=count%>
                                    </p>
                                </div>

                                <!-- Revenue Card -->
                                <div class="bg-white p-4 rounded-lg shadow-lg">
                                    <h3 class="text-lg font-semibold">Total Revenue</h3>
                                    <p class="text-2xl font-bold">$92,340</p>
                                </div>
                            </div>

                            <!-- Recent Orders Section -->
                            <!-- <div class="mt-6 bg-white p-4 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Recent Orders</h3>
                        <ul class="space-y-2">
                            <li class="flex justify-between border-b py-2">
                                <span>Order #1023</span>
                                <span class="text-green-500">Completed</span>
                            </li>
                            <li class="flex justify-between border-b py-2">
                                <span>Order #1024</span>
                                <span class="text-yellow-500">Pending</span>
                            </li>
                        </ul>
                    </div> -->
                        </section>
                    </div>
                    <div id="addProducts" class="content hidden">
                        <main class="flex-1 p-6 overflow-auto">

                            <!-- Header -->


                            <!-- Add Product Form -->
                            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h3 class="text-lg font-semibold mb-4">Product Details</h3>
                                <form class="grid grid-cols-1 md:grid-cols-2 gap-4" action="/products/create"
                                    method="post" enctype="multipart/form-data">
                                    <div class=" col-span-2 mb-4 px-2">
                                        <label class="block mb-2 font-medium ">Product Image:</label>
                                        <input type="file" name="images" multiple accept="image/*" required>
                                    </div>
                                    <input type="text" placeholder="Product Name" class="px-3 py-2 border rounded"
                                        name="name">
                                    <input type="number" placeholder="Price (‚Çπ)" class="px-3 py-2 border rounded"
                                        name="price">
                                    <input type="text" placeholder="Category" class="px-3 py-2 border rounded"
                                        name="category">

                                    <input type="number" placeholder="Discount" class="px-3 py-2 border rounded"
                                        name="discount">
                                    <input type="number" placeholder="Size" class="px-3 py-2 border rounded"
                                        name="size">
                                    <input type="text" placeholder="Color" class="px-3 py-2 border rounded"
                                        name="color">
                                    <input type="text" placeholder="Metal Type" class="px-3 py-2 border rounded"
                                        name="metal">
                                    <input type="Number" placeholder="Gold Qunatity in grams"
                                        class="px-3 py-2 border rounded" name="gold">
                                    <textarea placeholder="Product Description"
                                        class="px-3 py-2 border rounded col-span-2" name="description"></textarea>
                                    <button type="submit"
                                        class="bg-gray-900 text-white py-2 rounded col-span-2 hover:bg-gray-700">Add
                                        Product</button>
                                </form>
                            </section>
                        </main>
                    </div>
                    <div id="orders" class="content hidden">
                        <section class="p-6 bg-gray-100">
                            <h2 class="text-2xl font-bold mb-4">Orders Management</h2>
                            <div class="bg-white shadow rounded-lg p-4">
                                <table class="w-full text-sm text-left border border-gray-200">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="px-4 py-2">Order ID</th>
                                            <th class="px-4 py-2">Customer</th>
                                            <th class="px-4 py-2">Date</th>
                                            <th class="px-4 py-2">Amount</th>
                                            <th class="px-4 py-2">Status</th>
                                            <th class="px-4 py-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <% if(user.length>0 && orders.length>0){%>
                                        <%orders.forEach(function(order){%>
                                            <tbody>
                                                <tr class="border-b">
                                                    <td class="px-4 py-2">#1023</td>
                                                    <td class="px-4 py-2">
                                                        <%= order.userId ? order.userId.fullname : "Unknown User" %>
                                                    </td>
                                                    <td class="px-4 py-2">
                                                        Date: <%=new Date(order.createdAt).toLocaleDateString() %>
                                                    </td>
                                                    <td class="px-4 py-2">
                                                        <%=order.amount%>
                                                    </td>
                                                    <td class="px-4 py-2 text-green-500 font-semibold">
                                                        <%=order.status%>
                                                    </td>
                                                    <td class="px-4 py-2 text-green-500 font-semibold">
                                                        <form action="/owners/orders/<%= order._id %>/status"
                                                            method="POST">
                                                            <select name="status">
                                                                <option value="Pending">Pending</option>
                                                                <option value="Shipped">Shipped</option>
                                                                <option value="Delivered">Delivered</option>
                                                                <option value="Cancelled">Cancelled</option>
                                                            </select>
                                                            <button type="submit">Update</button>
                                                        </form>
                                                    </td>
                                                    <td class="px-4 py-2 space-x-2">
                                                        <a href="/owners/viewOrder/<%= order._id %>"
                                                            class="text-blue-500 hover:text-blue-700">View</a>


                                                    </td>
                                                </tr>
                                            </tbody>
                                            <% })%>
                                                <%}else {%>
                                                    <h1>No order found.</h1>
                                                    <% }%>
                                </table>
                            </div>
                        </section>
                    </div>
                    <div id="users" class="content hidden">
                        <section class="p-6 bg-gray-100">
                            <h2 class="text-2xl font-bold mb-4">Users Management</h2>
                            <div class="bg-white shadow rounded-lg p-4">
                                <table class="w-full text-sm text-left border border-gray-200">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="px-4 py-2">User ID</th>
                                            <th class="px-4 py-2">Name</th>
                                            <th class="px-4 py-2">Email</th>
                                            <th class="px-4 py-2">Role</th>
                                            <th class="px-4 py-2">Status</th>
                                            <th class="px-4 py-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if(user.length>0){%>
                                            <%user.forEach(function(usr){%>
                                                <tr class="border-b">
                                                    <td class="px-4 py-2">
                                                        <%=usr._id%>
                                                    </td>
                                                    <td class="px-4 py-2">
                                                        <%=usr.fullname%>
                                                    </td>
                                                    <td class="px-4 py-2">
                                                        <%=usr.email%>
                                                    </td>
                                                    <td class="px-4 py-2">
                                                        <%=usr.role%>
                                                    </td>
                                                    <td class="px-4 py-2 text-green-500 font-semibold">Active</td>
                                                    <td class="px-4 py-2">
                                                        <a href="/owners/viewUser/<%= usr._id %>"
                                                            class="text-blue-500 hover:text-blue-700">View</a>



                                                    </td>
                                                </tr>
                                                <%})%>
                                                    <%} else{ %>
                                                        <h1>No users. </h1>
                                                        <%}%>
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                    <div id="settings" class="content hidden flex">
                        <section class="p-6 bg-gray-100 w-[50%]">
                            <h2 class="text-2xl font-bold mb-4">Settings</h2>
                            <div class="bg-white shadow rounded-lg p-4 space-y-4">
                                <!-- General Settings -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2">General Settings</h3>
                                    <div class="flex flex-col space-y-2">
                                        <form class="flex flex-col space-y-2" action="/owners/edit/email" method="post">
                                            <label class="font-medium">Admin Email:</label>
                                            <input type="email" placeholder="Enter admin email"
                                                class="w-full p-2 border rounded">
                                            <input type="submit"
                                                class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                                                value="Change Email">
                                        </form>
                                    </div>
                                </div>

                                <!-- Security Settings -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2">Security Settings</h3>
                                    <div class="flex flex-col space-y-2">
                                        <form class="flex flex-col space-y-2" action="/owners/edit" method="post">
                                            <label class="font-medium">Old Password:</label>
                                            <input type="password" placeholder="old password"
                                                class="w-full p-2 border rounded" name="old">
                                            <label class="font-medium">New Password:</label>
                                            <input type="password" placeholder="New password"
                                                class="w-full p-2 border rounded" name="password">
                                            <input type="submit"
                                                class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                                                value="Update Password">
                                        </form>
                                    </div>
                                </div>

                                <!-- Save Button -->

                            </div>
                        </section>
                        <section class="p-6 bg-gray-100 w-[50%]">
                            <h2 class="text-2xl font-bold mb-4">Set Prices</h2>
                            <div class="bg-white shadow rounded-lg p-4 space-y-4">
                                <!-- views/admin/pricing.ejs -->
                                <form class="flex  flex-col gap-3" method="POST" action="/owners/update">
                                    <label>GST (%) : <%= pricing ? pricing.gst: "" %>%</label>
                                    <input class="outline-none border rounded-lg py-2 " type="number" name="gst"
                                        step="0.01" required>

                                    <label>Making Price (per gram) : <%= pricing ? pricing.makingPrice:""%>‚Çπ /G</label>
                                    <input class="outline-none border rounded-lg py-2" type="number" name="makingPrice"
                                        step="0.01" required>

                                    <label>Gold Price (per gram): <%= pricing ? pricing.goldPrice:""%>‚Çπ /G</label>
                                    <input class="outline-none border rounded-lg py-2" type="number" name="goldPrice"
                                        step="0.01" required>

                                    <button class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                                        type="submit">Update Pricing</button>
                                </form>

                            </div>
                        </section>
                    </div>
                    <div id="allProducts" class="content hidden flex gap-2 flex-wrap">
                        <% products.forEach(function(product){ %>
                            <div class="w-[17vw]">
                                <div class="bg-white shadow-lg rounded-xl overflow-hidden border">
                                    <input type="checkbox" class="product-checkbox" value="<%=product._id%>">
                                    <% if (product.images && product.images.length> 0) { %>
                                        <img src="data:image/jpeg;base64,<%= product.images[0].toString('base64') %>"
                                            class="w-full h-60 object-center object-cover" />
                                        <% } else { %>
                                            <p>No images available for this product.</p>
                                            <% } %>
                                                <div class="p-4">
                                                    <h2 class="font-bold text-lg text-nowrap">
                                                        <%=product.name%>
                                                    </h2>
                                                    <p class="text-sm text-gray-500">By Padmawat Jewellers</p>
                                                    <div class="flex justify-between items-center mt-3">
                                                        <span class="text-purple-600 font-semibold text-md">(‚Çπ)
                                                            <%=Number(Number(product.price) -
                                                                Number(product.discount))%>
                                                        </span>
                                                        <span class="text-purple-200 text-md line-through">
                                                            <%=product.price%>
                                                        </span>
                                                        <span class="text-gray-500 text-sm">
                                                            <%=product.gold%>G
                                                        </span>
                                                        <span class="text-gray-500 text-sm">SAVE:<%=product.discount%>
                                                        </span>
                                                    </div>

                                                </div>
                                </div>
                            </div>
                            <% }); %>
                                <div class="w-[20vw] h-[3vw] flex justify-end gap-4 mt-4">
                                    <button id="deleteSelected" class="bg-red-500 text-white py-2 px-4 rounded">Delete
                                        Selected</button>
                                    <button id="editProduct" class="bg-blue-500 text-white py-2 px-4 rounded">Edit
                                        Product</button>
                                </div>
                    </div>
                </main>
                <script>
                    function showSection(sectionId) {
                        document.querySelectorAll('.content').forEach(el => el.classList.add('hidden'));
                        document.getElementById(sectionId).classList.remove('hidden');
                    }

                    document.getElementById('deleteSelected').addEventListener('click', function () {
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(checkbox => checkbox.value);
                        if (selectedProducts.length > 0) {
                            fetch('/owners/delete-products', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ productIds: selectedProducts }),
                            }).then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        window.location.reload();
                                    }
                                });
                        }
                    });

                    document.getElementById('editProduct').addEventListener('click', function () {
                        const selectedProduct = document.querySelector('.product-checkbox:checked').value;
                        if (selectedProduct) {
                            window.location.href = `/owners/edit-product/${selectedProduct}`;
                        }
                    });
                    // delete user
                    async function deleteUser(userId) {
                        if (confirm("Are you sure you want to delete this user?")) {
                            try {
                                const response = await fetch(`/deleteUser/${userId}`, {
                                    method: "DELETE",
                                });
                                const data = await response.json();
                                if (data.success) {
                                    alert("User deleted successfully");
                                    window.location.reload(); // Refresh the page to reflect changes
                                } else {
                                    alert("Failed to delete user");
                                }
                            } catch (error) {
                                console.error("Error deleting user:", error);
                                alert("An error occurred while deleting the user");
                            }
                        }
                    }
                    //cancel order

                    // async function cancelOrder(orderId) {
                    //     if (confirm("Are you sure you want to cancel this order?")) {
                    //         try {
                    //             const response = await fetch(`/cancelOrder/${orderId}`, {
                    //                 method: "DELETE",
                    //             });
                    //             const data = await response.json();
                    //             console.log("HI");
                    //             if (data.success) {
                    //                 alert("Order cancelled successfully");
                    //                 window.location.reload(); // Refresh the page to reflect changes
                    //             } else {
                    //                 alert("Failed to cancel order");
                    //             }
                    //         } catch (error) {
                    //             console.error("Error cancelling order:", error);
                    //             alert("An error occurred while cancelling the order");
                    //         }
                    //     }
                    // }
                    //update status
                    function updateOrderStatus(orderId, status) {
                        fetch(`/orders/${orderId}/status`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ status }),
                        })
                            .then((res) => res.json())
                            .then(() => {
                                window.location.reload(); // Reloads the page to reflect the changes
                            })
                            .catch((err) => console.error(err));
                    }

                    //cancel order
                    function cancelOrder(orderId) {
                        fetch(`/owners/orders/${orderId}/cancel`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                alert("Order cancelled successfully");
                                window.location.reload(); // Refresh to update status
                            })
                            .catch((err) => console.error("Error cancelling order:", err));
                    }



                </script>

            </div>
            <%- include('./partials/footer') %>